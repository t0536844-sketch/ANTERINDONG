<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediTransport - Sistem Antar Jemput Pasien</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #2563eb; --primary-dark: #1d4ed8;
            --secondary: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
            --gray-300: #d1d5db; --gray-400: #9ca3af; --gray-500: #6b7280;
            --gray-600: #4b5563; --gray-700: #374151; --gray-800: #1f2937;
        }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .app-container { max-width: 1200px; margin: 0 auto; }
        
        /* Header & Nav */
        .header { background: white; border-radius: 16px; padding: 24px 32px; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 48px; height: 48px; background: linear-gradient(135deg, #2563eb 0%, #764ba2 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; }
        .logo-text h1 { font-size: 24px; font-weight: 700; color: var(--gray-800); }
        .logo-text p { font-size: 13px; color: var(--gray-500); }
        .role-selector { display: flex; gap: 8px; flex-wrap: wrap; }
        .role-btn { padding: 10px 20px; border: 2px solid var(--gray-200); background: white; border-radius: 8px; font-size: 14px; font-weight: 600; color: var(--gray-600); cursor: pointer; transition: all 0.3s ease; }
        .role-btn:hover { border-color: var(--primary); color: var(--primary); }
        .role-btn.active { background: var(--primary); border-color: var(--primary); color: white; }

        /* Dashboard Grid */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; }
        .card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid var(--gray-100); }
        .card-title { font-size: 18px; font-weight: 700; color: var(--gray-800); display: flex; align-items: center; gap: 8px; }
        .card-title-icon { width: 32px; height: 32px; background: linear-gradient(135deg, #2563eb 0%, #764ba2 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; }

        /* Forms */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 14px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px; }
        .form-group label .required { color: var(--danger); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 16px; font-size: 14px; font-family: inherit; border: 2px solid var(--gray-200); border-radius: 8px; background: var(--gray-50); color: var(--gray-800); transition: all 0.3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-group select { appearance: none; background-image: url("image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20' fill='%236b7280'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 40px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

        /* Buttons */
        .btn { padding: 12px 24px; font-size: 14px; font-weight: 600; font-family: inherit; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #2563eb 0%, #764ba2 100%); color: white; width: 100%; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4); }
        .btn-success { background: var(--secondary); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: white; border: 2px solid var(--gray-200); color: var(--gray-600); }
        .btn-add { padding: 12px 16px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .btn-group { display: flex; gap: 12px; margin-top: 20px; }
        .btn-group .btn { flex: 1; }

        /* Status & Lists */
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-processing { background: #dbeafe; color: #1e40af; }
        .status-onway { background: #e0e7ff; color: #3730a3; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-cancelled { background: #fee2e2; color: #991b1b; }
        .order-list { max-height: 400px; overflow-y: auto; }
        .order-item { padding: 16px; border: 2px solid var(--gray-100); border-radius: 12px; margin-bottom: 12px; transition: all 0.3s ease; }
        .order-item:hover { border-color: var(--primary); background: var(--gray-50); }
        .order-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .order-id { font-size: 14px; font-weight: 700; color: var(--gray-800); }
        .order-patient { font-size: 16px; font-weight: 600; color: var(--gray-800); margin-bottom: 8px; }
        .order-details { font-size: 13px; color: var(--gray-500); margin-bottom: 4px; }
        .order-actions { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
        .order-actions .btn { flex: 1; min-width: 80px; padding: 8px 12px; font-size: 12px; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: linear-gradient(135deg, #2563eb 0%, #764ba2 100%); border-radius: 12px; padding: 20px; color: white; }
        .stat-card.green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .stat-card.orange { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .stat-card.red { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .stat-card.purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .stat-value { font-size: 32px; font-weight: 700; margin-bottom: 4px; }
        .stat-label { font-size: 13px; opacity: 0.9; }

        /* Components */
        .documentation-section { background: var(--gray-50); border-radius: 12px; padding: 20px; margin-top: 20px; }
        .documentation-section h4 { font-size: 15px; font-weight: 600; color: var(--gray-800); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .photo-upload { border: 2px dashed var(--gray-300); border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.3s ease; margin-bottom: 16px; }
        .photo-upload:hover { border-color: var(--primary); background: var(--gray-100); }
        .photo-upload-icon { font-size: 40px; margin-bottom: 8px; }
        .photo-preview { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; margin-top: 16px; }
        .photo-item { position: relative; border-radius: 8px; overflow: hidden; aspect-ratio: 1; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        
        .datetime-display { background: var(--gray-100); padding: 12px 16px; border-radius: 8px; font-size: 13px; color: var(--gray-600); margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
        .input-with-button { display: flex; gap: 8px; }
        .input-with-button select, .input-with-button input { flex: 1; }
        .audit-section { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; margin-top: 20px; }
        .audit-section h4 { font-size: 15px; font-weight: 600; color: #92400e; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .cost-input-section { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 2px solid #2563eb; border-radius: 12px; padding: 20px; margin-top: 16px; }
        .cost-input-section h4 { font-size: 15px; font-weight: 600; color: #1e40af; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .cancel-reason-section { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border: 2px solid #ef4444; border-radius: 12px; padding: 20px; margin-top: 16px; }
        .cancel-reason-section h4 { font-size: 15px; font-weight: 600; color: #991b1b; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        
        .map-placeholder { background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border-radius: 12px; height: 200px; display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: 600; margin-bottom: 20px; }
        .location-icon { display: inline-flex; align-items: center; gap: 4px; color: var(--primary); font-weight: 500; }
        .cost-badge { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 8px 16px; border-radius: 8px; font-weight: 700; font-size: 16px; }
        .cost-badge.pending { background: var(--gray-300); font-size: 12px; padding: 4px 10px; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; animation: modalSlide 0.3s ease; }
        @keyframes modalSlide { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { padding: 20px 24px; border-bottom: 2px solid var(--gray-100); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 18px; font-weight: 700; color: var(--gray-800); }
        .modal-close { width: 32px; height: 32px; border: none; background: var(--gray-100); border-radius: 8px; cursor: pointer; font-size: 20px; color: var(--gray-500); }
        .modal-close:hover { background: var(--danger); color: white; }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 20px 24px; border-top: 2px solid var(--gray-100); display: flex; gap: 12px; justify-content: flex-end; }

        /* Timeline */
        .timeline { position: relative; padding-left: 30px; }
        .timeline::before { content: ''; position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: var(--gray-200); }
        .timeline-item { position: relative; padding-bottom: 24px; }
        .timeline-item::before { content: ''; position: absolute; left: -26px; top: 4px; width: 16px; height: 16px; border-radius: 50%; background: var(--primary); border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .timeline-item.completed::before { background: var(--secondary); }
        .timeline-item.cancelled::before { background: var(--danger); }
        .timeline-time { font-size: 12px; color: var(--gray-400); margin-bottom: 4px; }
        .timeline-content { font-size: 14px; color: var(--gray-700); }

        /* Notification */
        .notification { position: fixed; top: 20px; right: 20px; padding: 16px 24px; background: white; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.2); display: none; align-items: center; gap: 12px; z-index: 2000; animation: slideIn 0.3s ease; }
        .notification.show { display: flex; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
        .notification-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .notification.success .notification-icon { background: #d1fae5; color: #059669; }
        .notification.error .notification-icon { background: #fee2e2; color: #dc2626; }
        .notification.warning .notification-icon { background: #fef3c7; color: #d97706; }
        .notification-content { flex: 1; }
        .notification-title { font-size: 14px; font-weight: 600; color: var(--gray-800); }
        .notification-message { font-size: 13px; color: var(--gray-500); }

        .hidden { display: none !important; }

        /* Print Styles */
        @media print {
            body { background: white; padding: 0; }
            .header, .role-selector, .btn, .no-print, .dashboard > .card:not(.print-only) { display: none !important; }
            .app-container { max-width: 100%; margin: 0; }
            .card { box-shadow: none; border: 1px solid #ddd; }
            .print-only { display: block !important; width: 100%; }
            .modal { position: static; background: white; display: block !important; }
            .modal-content { max-width: 100%; box-shadow: none; }
            .modal-header, .modal-footer { display: none; }
            .modal-body { padding: 0; }
            .btn-group { display: none; }
        }
        .print-only { display: none; }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">ğŸš‘</div>
                <div class="logo-text">
                    <h1>MediTransport</h1>
                    <p>Sistem Antar Jemput Pasien Terintegrasi</p>
                </div>
            </div>
            <div class="role-selector">
                <button class="role-btn active" data-role="perawatan">Petugas Perawatan</button>
                <button class="role-btn" data-role="jaga">Petugas Jaga</button>
                <button class="role-btn" data-role="driver">Driver Maxim</button>
                <button class="role-btn" data-role="admin">Admin Monitoring</button>
            </div>
        </header>

        <!-- Dashboard Petugas Perawatan -->
        <div id="perawatan-dashboard" class="dashboard">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><span class="card-title-icon">ğŸ“‹</span> Buat Order Baru</h2>
                </div>
                <div class="datetime-display"><span id="currentDate">ğŸ“… -</span><span id="currentTime">ğŸ• -</span></div>
                <form id="orderForm">
                    <div class="form-group"><label>Nomor Rekam Medik <span class="required">*</span></label><input type="text" id="medicalRecordNumber" placeholder="Contoh: MRN-2024-001" required></div>
                    <div class="form-group"><label>Nama Pasien <span class="required">*</span></label><input type="text" id="patientName" placeholder="Masukkan nama pasien" required></div>
                    <div class="form-row">
                        <div class="form-group"><label>Tempat Lahir <span class="required">*</span></label><input type="text" id="birthPlace" placeholder="Kota kelahiran" required></div>
                        <div class="form-group"><label>Tanggal Lahir <span class="required">*</span></label><input type="date" id="birthDate" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Umur (Otomatis)</label><input type="text" id="patientAge" readonly style="background: var(--gray-200);"></div>
                        <div class="form-group"><label>Jenis Kelamin <span class="required">*</span></label><select id="patientGender" required><option value="">Pilih</option><option value="L">Laki-laki</option><option value="P">Perempuan</option></select></div>
                    </div>
                    <div class="form-group"><label>Nomor Telepon <span class="required">*</span></label><input type="tel" id="patientPhone" placeholder="08xxxxxxxxxx" required></div>
                    <div class="form-group"><label>Kondisi Pasien <span class="required">*</span></label><select id="patientCondition" required><option value="">Pilih kondisi</option><option value="stabil">Stabil</option><option value="peringatan">Perlu Perhatian</option><option value="kritis">Kritis</option></select></div>
                    <div class="form-group">
                        <label>Ruang / Bangsal Perawatan <span class="required">*</span></label>
                        <div class="input-with-button">
                            <select id="wardSelect" required><option value="">Pilih ruang/bangsal</option><option value="rawat_inap_1">Ruang Rawat Inap 1</option><option value="rawat_inap_2">Ruang Rawat Inap 2</option><option value="rawat_inap_3">Ruang Rawat Inap 3</option><option value="vip_1">Ruang VIP 1</option><option value="vip_2">Ruang VIP 2</option><option value="icu">ICU</option><option value="hcu">HCU</option><option value="nicu">NICU</option><option value="perina">Perina</option><option value="bedah">Ruang Bedah</option></select>
                            <button type="button" class="btn-add" onclick="addNewWard()">+ Baru</button>
                        </div>
                        <input type="text" id="wardCustom" placeholder="Atau ketik ruang/bangsal baru" style="margin-top: 8px; display: none;">
                    </div>
                    <div class="form-group"><label>Lokasi Penjemputan <span class="required">*</span></label><select id="pickupLocation" required><option value="">Pilih lokasi penjemputan</option><option value="lobby_depan">ğŸ¥ Lobby Depan</option><option value="lobby_belakang">ğŸ¥ Lobby Belakang</option><option value="lobby_elang">ğŸ¦… Lobby Elang</option><option value="lobby_ird">ğŸš¨ Lobby IRD</option></select></div>
                    <div class="form-group"><label>Tujuan <span class="required">*</span></label><input type="text" id="destination" placeholder="Alamat tujuan" required></div>
                    <div class="form-group"><label>Catatan Tambahan</label><textarea id="notes" placeholder="Catatan khusus untuk driver..."></textarea></div>
                    <div class="documentation-section">
                        <h4>ğŸ“¸ Dokumentasi Sebelum Berangkat</h4>
                        <div class="photo-upload" id="beforePhotoUpload"><div class="photo-upload-icon">ğŸ“·</div><div class="photo-upload-text">Klik untuk upload foto pasien</div><input type="file" id="beforePhoto" accept="image/*" multiple hidden></div>
                        <div class="photo-preview" id="beforePhotoPreview"></div>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">ğŸš€ Submit Order</button>
                        <button type="button" class="btn btn-danger" onclick="resetOrderForm()">âŒ Batal</button>
                    </div>
                </form>
            </div>
            <div class="card">
                <div class="card-header"><h2 class="card-title"><span class="card-title-icon">ğŸ“Š</span> Riwayat Order</h2></div>
                <div class="order-list" id="perawatanOrderList"></div>
            </div>
        </div>

        <!-- Dashboard Petugas Jaga -->
        <div id="jaga-dashboard" class="dashboard hidden">
            <div class="card">
                <div class="card-header"><h2 class="card-title"><span class="card-title-icon">ğŸ“¬</span> Order Masuk</h2><span class="status-badge status-pending" id="pendingCount">0 Pending</span></div>
                <div class="datetime-display"><span id="jagaCurrentDate">ğŸ“… -</span><span id="jagaCurrentTime">ğŸ• -</span></div>
                <div class="order-list" id="jagaOrderList"></div>
            </div>
            <div class="card">
                <div class="card-header"><h2 class="card-title"><span class="card-title-icon">ğŸš—</span> Driver & Kendaraan</h2><button class="btn-add" onclick="addNewDriver()">+ Driver</button></div>
                <div class="order-list" id="driverList"></div>
            </div>
        </div>

        <!-- Dashboard Driver Maxim -->
        <div id="driver-dashboard" class="dashboard hidden">
            <div class="card">
                <div class="card-header"><h2 class="card-title"><span class="card-title-icon">ğŸ¯</span> Tugas Saya</h2></div>
                <div class="datetime-display"><span id="driverCurrentDate">ğŸ“… -</span><span id="driverCurrentTime">ğŸ• -</span></div>
                <div class="map-placeholder">ğŸ—ºï¸ Peta Navigasi (Integrasi Maps)</div>
                <div class="order-list" id="driverOrderList"></div>
            </div>
            <div class="card">
                <div class="card-header"><h2 class="card-title"><span class="card-title-icon">ğŸ“¸</span> Dokumentasi & Audit</h2></div>
                <div class="documentation-section">
                    <h4>ğŸ“ Foto Saat Tiba di Tujuan</h4>
                    <div class="photo-upload" id="arrivalPhotoUpload"><div class="photo-upload-icon">ğŸ“·</div><div class="photo-upload-text">Klik untuk upload foto kedatangan</div><input type="file" id="arrivalPhoto" accept="image/*" multiple hidden></div>
                    <div class="photo-preview" id="arrivalPhotoPreview"></div>
                </div>
                <div class="form-group" style="margin-top: 20px;"><label>Catatan Pengantaran</label><textarea id="deliveryNotes" placeholder="Catatan kondisi saat pengantaran..."></textarea></div>
                <div class="audit-section">
                    <h4>ğŸ“‹ Info Audit Order</h4>
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom: 0;"><label>Nama Driver</label><input type="text" id="driverNameAudit" readonly style="background: var(--gray-200);"></div>
                        <div class="form-group" style="margin-bottom: 0;"><label>Nomor Kendaraan</label><input type="text" id="vehicleNumberAudit" readonly style="background: var(--gray-200);"></div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0; margin-top: 12px;"><label>Biaya Order</label><input type="text" id="costAudit" readonly style="background: var(--gray-200);"></div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" id="completeDelivery">âœ… Selesaikan</button>
                    <button class="btn btn-danger" id="cancelDelivery">âŒ Batal</button>
                </div>
            </div>
        </div>

        <!-- Dashboard Admin Monitoring -->
        <div id="admin-dashboard" class="dashboard hidden">
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-header"><h2 class="card-title"><span class="card-title-icon">ğŸ“ˆ</span> Statistik Hari Ini</h2></div>
                <div class="datetime-display"><span id="adminCurrentDate">ğŸ“… -</span><span id="adminCurrentTime">ğŸ• -</span></div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="totalOrders">0</div><div class="stat-label">Total Order</div></div>
                    <div class="stat-card green"><div class="stat-value" id="completedOrders">0</div><div class="stat-label">Selesai</div></div>
                    <div class="stat-card orange"><div class="stat-value" id="pendingOrders">0</div><div class="stat-label">Pending</div></div>
                    <div class="stat-card red"><div class="stat-value" id="cancelledOrders">0</div><div class="stat-label">Dibatalkan</div></div>
                    <div class="stat-card purple"><div class="stat-value" id="totalRevenue">Rp 0</div><div class="stat-label">Total Pendapatan</div></div>
                </div>
            </div>

            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-header">
                    <h2 class="card-title"><span class="card-title-icon">ğŸ“‹</span> Laporan Rutin</h2>
                    <button class="btn btn-outline" onclick="generateReport()" style="width: auto;">ğŸ–¨ï¸ Cetak Laporan</button>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Dari Tanggal</label><input type="date" id="reportStartDate"></div>
                    <div class="form-group"><label>Sampai Tanggal</label><input type="date" id="reportEndDate"></div>
                </div>
                <div id="reportPreview" style="margin-top: 20px; border: 1px solid var(--gray-200); border-radius: 8px; padding: 20px; background: var(--gray-50);">
                    <p style="text-align: center; color: var(--gray-500);">Silakan pilih tanggal untuk melihat laporan</p>
                </div>
            </div>

            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-header"><h2 class="card-title"><span class="card-title-icon">ğŸ“‹</span> Semua Order (Audit Trail)</h2></div>
                <div class="order-list" id="adminOrderList"></div>
            </div>
        </div>
    </div>

    <!-- Modal Detail Order (With Print) -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Detail Order</h3>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <!-- Modal Assign Driver -->
    <div class="modal" id="assignModal">
        <div class="modal-content">
            <div class="modal-header"><h3>Assign Driver & Biaya</h3><button class="modal-close" onclick="closeAssignModal()">Ã—</button></div>
            <div class="modal-body">
                <div class="form-group"><label>Pilih Driver <span class="required">*</span></label><select id="assignDriverSelect"><option value="">Pilih driver tersedia</option></select></div>
                <div class="cost-input-section">
                    <h4>ğŸ’° Biaya Transportasi</h4>
                    <div class="form-group" style="margin-bottom: 0;"><label>Biaya Order ke Driver Maxim (Rp) <span class="required">*</span></label><input type="number" id="assignOrderCost" placeholder="Masukkan biaya transportasi"></div>
                    <p style="font-size: 12px; color: var(--gray-500); margin-top: 8px;">â„¹ï¸ Biaya akan dicatat untuk keperluan audit dan akan terlihat oleh driver</p>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-outline" onclick="closeAssignModal()">Batal</button><button class="btn btn-primary" onclick="confirmAssignDriver()">âœ“ Assign Driver</button></div>
        </div>
    </div>

    <!-- Modal Cancel Order -->
    <div class="modal" id="cancelModal">
        <div class="modal-content">
            <div class="modal-header"><h3>âŒ Batal Order</h3><button class="modal-close" onclick="closeCancelModal()">Ã—</button></div>
            <div class="modal-body">
                <p style="color: var(--gray-600); margin-bottom: 16px;">Apakah Anda yakin ingin membatalkan order ini? Tindakan ini tidak dapat dibatalkan.</p>
                <div class="cancel-reason-section">
                    <h4>ğŸ“ Alasan Pembatalan</h4>
                    <div class="form-group" style="margin-bottom: 0;"><label>Pilih Alasan <span class="required">*</span></label><select id="cancelReason"><option value="">Pilih alasan pembatalan</option><option value="patient_cancel">Pasien Membatalkan</option><option value="patient_condition">Kondisi Pasien Berubah</option><option value="no_driver">Tidak Ada Driver Tersedia</option><option value="schedule_conflict">Jadwal Bentrok</option><option value="other_transport">Menggunakan Transportasi Lain</option><option value="medical_reason">Alasan Medis</option><option value="admin_request">Permintaan Admin</option><option value="other">Lainnya</option></select></div>
                    <div class="form-group" style="margin-bottom: 0; margin-top: 12px;"><label>Catatan Tambahan</label><textarea id="cancelNotes" placeholder="Jelaskan alasan pembatalan lebih detail..." style="min-height: 80px;"></textarea></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-outline" onclick="closeCancelModal()">Kembali</button><button class="btn btn-danger" onclick="confirmCancelOrder()">âœ“ Konfirmasi Batal</button></div>
        </div>
    </div>

    <!-- Modal Add Driver -->
    <div class="modal" id="driverModal">
        <div class="modal-content">
            <div class="modal-header"><h3>Tambah Driver Baru</h3><button class="modal-close" onclick="closeDriverModal()">Ã—</button></div>
            <div class="modal-body">
                <div class="form-group"><label>Nama Driver <span class="required">*</span></label><input type="text" id="newDriverName" placeholder="Nama lengkap driver"></div>
                <div class="form-group"><label>Nomor Telepon <span class="required">*</span></label><input type="tel" id="newDriverPhone" placeholder="08xxxxxxxxxx"></div>
                <div class="form-group"><label>Jenis Kendaraan <span class="required">*</span></label><input type="text" id="newDriverVehicle" placeholder="Contoh: Toyota Avanza"></div>
                <div class="form-group"><label>Nomor Polisi <span class="required">*</span></label><input type="text" id="newDriverPlate" placeholder="Contoh: B 1234 ABC"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-outline" onclick="closeDriverModal()">Batal</button><button class="btn btn-primary" onclick="saveNewDriver()">Simpan</button></div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-icon">âœ“</div>
        <div class="notification-content"><div class="notification-title">Berhasil</div><div class="notification-message">Order telah dibuat</div></div>
    </div>

    <script>
        // Data Storage
        let orders = [];
        let drivers = [
            { id: 1, name: 'Ahmad Rizki', phone: '081234567890', vehicle: 'Toyota Avanza', plate: 'B 1234 ABC', status: 'available' },
            { id: 2, name: 'Budi Santoso', phone: '081234567891', vehicle: 'Honda Mobilio', plate: 'B 5678 DEF', status: 'available' },
            { id: 3, name: 'Cahyo Widodo', phone: '081234567892', vehicle: 'Suzuki Ertiga', plate: 'B 9012 GHI', status: 'busy' },
            { id: 4, name: 'Dedi Kurniawan', phone: '081234567893', vehicle: 'Daihatsu Xenia', plate: 'B 3456 JKL', status: 'available' }
        ];
        let wards = ['Ruang Rawat Inap 1', 'Ruang Rawat Inap 2', 'Ruang Rawat Inap 3', 'Ruang VIP 1', 'Ruang VIP 2', 'ICU', 'HCU', 'NICU', 'Perina', 'Ruang Bedah'];
        let currentRole = 'perawatan';
        let selectedOrder = null;
        let beforePhotos = [];
        let arrivalPhotos = [];
        let dateTimeInterval;
        let orderToAssign = null;
        let orderToCancel = null;

        const pickupLocations = { 'lobby_depan': 'ğŸ¥ Lobby Depan', 'lobby_belakang': 'ğŸ¥ Lobby Belakang', 'lobby_elang': 'ğŸ¦… Lobby Elang', 'lobby_ird': 'ğŸš¨ Lobby IRD' };
        const cancelReasons = { 'patient_cancel': 'Pasien Membatalkan', 'patient_condition': 'Kondisi Pasien Berubah', 'no_driver': 'Tidak Ada Driver Tersedia', 'schedule_conflict': 'Jadwal Bentrok', 'other_transport': 'Menggunakan Transportasi Lain', 'medical_reason': 'Alasan Medis', 'admin_request': 'Permintaan Admin', 'other': 'Lainnya' };
        const roleNames = { 'perawatan': 'Petugas Perawatan', 'jaga': 'Petugas Jaga', 'driver': 'Driver Maxim', 'admin': 'Admin Monitoring' };

        document.addEventListener('DOMContentLoaded', function() {
            loadOrders(); loadDrivers(); loadWards(); startDateTime(); renderAllDashboards(); setupEventListeners();
            // Set default report dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportStartDate').value = today;
            document.getElementById('reportEndDate').value = today;
        });

        function startDateTime() { updateDateTime(); dateTimeInterval = setInterval(updateDateTime, 1000); }
        function updateDateTime() {
            const now = new Date();
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            const dateString = now.toLocaleDateString('id-ID', dateOptions);
            const timeString = now.toLocaleTimeString('id-ID', timeOptions);
            document.getElementById('currentDate').textContent = 'ğŸ“… ' + dateString; document.getElementById('currentTime').textContent = 'ğŸ• ' + timeString;
            document.getElementById('jagaCurrentDate').textContent = 'ğŸ“… ' + dateString; document.getElementById('jagaCurrentTime').textContent = 'ğŸ• ' + timeString;
            document.getElementById('driverCurrentDate').textContent = 'ğŸ“… ' + dateString; document.getElementById('driverCurrentTime').textContent = 'ğŸ• ' + timeString;
            document.getElementById('adminCurrentDate').textContent = 'ğŸ“… ' + dateString; document.getElementById('adminCurrentTime').textContent = 'ğŸ• ' + timeString;
        }

        function loadOrders() { const saved = localStorage.getItem('mediTransportOrders'); if (saved) orders = JSON.parse(saved); }
        function saveOrders() { localStorage.setItem('mediTransportOrders', JSON.stringify(orders)); }
        function loadDrivers() { const saved = localStorage.getItem('mediTransportDrivers'); if (saved) drivers = JSON.parse(saved); }
        function saveDrivers() { localStorage.setItem('mediTransportDrivers', JSON.stringify(drivers)); }
        function loadWards() { const saved = localStorage.getItem('mediTransportWards'); if (saved) wards = JSON.parse(saved); populateWardSelect(); }
        function saveWards() { localStorage.setItem('mediTransportWards', JSON.stringify(wards)); }
        function populateWardSelect() {
            const select = document.getElementById('wardSelect');
            select.innerHTML = '<option value="">Pilih ruang/bangsal</option>';
            wards.forEach(function(ward, index) { select.innerHTML += '<option value="ward_' + index + '">' + ward + '</option>'; });
        }

        function addNewWard() {
            const customInput = document.getElementById('wardCustom'); const select = document.getElementById('wardSelect');
            if (customInput.style.display === 'none') { customInput.style.display = 'block'; select.style.display = 'none'; customInput.focus(); }
            else {
                const newWard = customInput.value.trim();
                if (newWard) {
                    wards.push(newWard); saveWards(); populateWardSelect();
                    select.value = 'ward_' + (wards.length - 1); customInput.style.display = 'none'; select.style.display = 'block';
                    showNotification('success', 'Ruang Ditambahkan', 'Ruang "' + newWard + '" berhasil ditambahkan');
                }
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('.role-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.role-btn').forEach(function(b) { b.classList.remove('active'); });
                    this.classList.add('active'); currentRole = this.dataset.role; switchDashboard();
                });
            });
            document.getElementById('birthDate').addEventListener('change', calculateAge);
            document.getElementById('wardSelect').addEventListener('change', function() { document.getElementById('wardCustom').style.display = 'none'; this.style.display = 'block'; });
            document.getElementById('orderForm').addEventListener('submit', handleOrderSubmit);
            document.getElementById('beforePhotoUpload').addEventListener('click', function() { document.getElementById('beforePhoto').click(); });
            document.getElementById('beforePhoto').addEventListener('change', handleBeforePhoto);
            document.getElementById('arrivalPhotoUpload').addEventListener('click', function() { document.getElementById('arrivalPhoto').click(); });
            document.getElementById('arrivalPhoto').addEventListener('change', handleArrivalPhoto);
            document.getElementById('completeDelivery').addEventListener('click', handleCompleteDelivery);
            document.getElementById('cancelDelivery').addEventListener('click', handleCancelDelivery);
        }

        function calculateAge() {
            const birthDate = document.getElementById('birthDate').value; if (!birthDate) return;
            const birth = new Date(birthDate); const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) age--;
            document.getElementById('patientAge').value = age + ' tahun';
        }

        function switchDashboard() {
            document.getElementById('perawatan-dashboard').classList.add('hidden');
            document.getElementById('jaga-dashboard').classList.add('hidden');
            document.getElementById('driver-dashboard').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.add('hidden');
            document.getElementById(currentRole + '-dashboard').classList.remove('hidden');
            renderAllDashboards();
        }

        function resetOrderForm() {
            document.getElementById('orderForm').reset(); beforePhotos = []; document.getElementById('beforePhotoPreview').innerHTML = '';
            document.getElementById('wardCustom').style.display = 'none'; document.getElementById('wardSelect').style.display = 'block';
            showNotification('warning', 'Form Dibatalkan', 'Form order telah direset');
        }

        function handleOrderSubmit(e) {
            e.preventDefault();
            const wardSelect = document.getElementById('wardSelect'); const wardCustom = document.getElementById('wardCustom');
            let wardValue = wardSelect.value;
            if (wardCustom.style.display === 'block' && wardCustom.value.trim()) { wardValue = wardCustom.value.trim(); }
            else { const wardIndex = parseInt(wardSelect.value.replace('ward_', '')); wardValue = wards[wardIndex] || wardSelect.value; }

            const order = {
                id: 'ORD-' + Date.now().toString().slice(-6), medicalRecordNumber: document.getElementById('medicalRecordNumber').value,
                patientName: document.getElementById('patientName').value, birthPlace: document.getElementById('birthPlace').value,
                birthDate: document.getElementById('birthDate').value, patientAge: document.getElementById('patientAge').value,
                patientGender: document.getElementById('patientGender').value, patientPhone: document.getElementById('patientPhone').value,
                patientCondition: document.getElementById('patientCondition').value, ward: wardValue,
                pickupLocation: document.getElementById('pickupLocation').value, destination: document.getElementById('destination').value,
                orderCost: null, notes: document.getElementById('notes').value, beforePhotos: beforePhotos, status: 'pending',
                createdAt: new Date().toISOString(), createdBy: 'perawatan',
                timeline: [{ time: new Date().toISOString(), action: 'Order dibuat oleh Petugas Perawatan', status: 'completed' }]
            };
            orders.unshift(order); saveOrders();
            showNotification('success', 'Order Berhasil', 'Order telah dibuat dan menunggu persetujuan Petugas Jaga');
            resetOrderForm(); renderAllDashboards();
        }

        function handleBeforePhoto(e) {
            const files = e.target.files;
            for (let i = 0; i < files.length; i++) {
                const reader = new FileReader();
                reader.onload = function(event) { beforePhotos.push(event.target.result); renderPhotoPreview('beforePhotoPreview', beforePhotos); };
                reader.readAsDataURL(files[i]);
            }
        }

        function handleArrivalPhoto(e) {
            const files = e.target.files;
            for (let i = 0; i < files.length; i++) {
                const reader = new FileReader();
                reader.onload = function(event) { arrivalPhotos.push(event.target.result); renderPhotoPreview('arrivalPhotoPreview', arrivalPhotos); };
                reader.readAsDataURL(files[i]);
            }
        }

        function renderPhotoPreview(containerId, photos) {
            const container = document.getElementById(containerId);
            container.innerHTML = photos.map(function(photo, index) { return '<div class="photo-item"><img src="' + photo + '" alt="Photo ' + (index + 1) + '"></div>'; }).join('');
        }

        function clearDriverDeliveryForm() {
            arrivalPhotos = []; document.getElementById('arrivalPhotoPreview').innerHTML = ''; document.getElementById('deliveryNotes').value = '';
            document.getElementById('driverNameAudit').value = ''; document.getElementById('vehicleNumberAudit').value = '';
            document.getElementById('costAudit').value = ''; document.getElementById('arrivalPhoto').value = ''; selectedOrder = null;
        }

        function handleCompleteDelivery() {
            if (!selectedOrder) { showNotification('error', 'Error', 'Pilih order terlebih dahulu'); return; }
            const orderIndex = orders.findIndex(function(o) { return o.id === selectedOrder.id; }); if (orderIndex === -1) return;
            orders[orderIndex].status = 'completed'; orders[orderIndex].arrivalPhotos = arrivalPhotos;
            orders[orderIndex].deliveryNotes = document.getElementById('deliveryNotes').value;
            orders[orderIndex].completedAt = new Date().toISOString(); orders[orderIndex].completedBy = currentRole;
            orders[orderIndex].timeline.push({ time: new Date().toISOString(), action: 'Pengantaran selesai - Driver Maxim', status: 'completed' });
            if (orders[orderIndex].assignedDriver) {
                const driverIndex = drivers.findIndex(function(d) { return d.id === orders[orderIndex].assignedDriver.id; });
                if (driverIndex !== -1) { drivers[driverIndex].status = 'available'; saveDrivers(); }
            }
            saveOrders(); showNotification('success', 'Pengantaran Selesai', 'Order telah diselesaikan');
            clearDriverDeliveryForm(); renderAllDashboards(); closeModal();
        }

        function handleCancelDelivery() { if (!selectedOrder) { showNotification('error', 'Error', 'Pilih order terlebih dahulu'); return; } orderToCancel = selectedOrder; document.getElementById('cancelModal').classList.add('show'); }

        function renderAllDashboards() { renderPerawatanDashboard(); renderJagaDashboard(); renderDriverDashboard(); renderAdminDashboard(); }

        function renderPerawatanDashboard() {
            const container = document.getElementById('perawatanOrderList');
            const userOrders = orders.filter(function(o) { return o.createdBy === 'perawatan'; });
            if (userOrders.length === 0) { container.innerHTML = '<p style="text-align: center; color: var(--gray-400); padding: 40px;">Belum ada order</p>'; return; }
            container.innerHTML = userOrders.map(function(order) { return createOrderItem(order); }).join('');
        }

        function renderJagaDashboard() {
            const pendingOrders = orders.filter(function(o) { return o.status === 'pending'; });
            document.getElementById('pendingCount').textContent = pendingOrders.length + ' Pending';
            const container = document.getElementById('jagaOrderList');
            if (pendingOrders.length === 0) { container.innerHTML = '<p style="text-align: center; color: var(--gray-400); padding: 40px;">Tidak ada order pending</p>'; return; }
            container.innerHTML = pendingOrders.map(function(order) { return createOrderItem(order, true); }).join('');
            const driverContainer = document.getElementById('driverList');
            driverContainer.innerHTML = drivers.map(function(driver) {
                return '<div class="order-item"><div class="order-patient">ğŸ‘¤ ' + driver.name + '</div><div class="order-details">ğŸš— ' + driver.vehicle + '</div><div class="order-details">ğŸ”– ' + driver.plate + '</div><div class="order-details">ğŸ“ ' + driver.phone + '</div><div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;"><span class="status-badge ' + (driver.status === 'available' ? 'status-completed' : 'status-pending') + '">' + (driver.status === 'available' ? 'Tersedia' : 'Sibuk') + '</span></div></div>';
            }).join('');
        }

        function renderDriverDashboard() {
            const container = document.getElementById('driverOrderList');
            const activeOrders = orders.filter(function(o) { return o.status === 'onway' || o.status === 'processing'; });
            if (activeOrders.length === 0) { container.innerHTML = '<p style="text-align: center; color: var(--gray-400); padding: 40px;">Tidak ada tugas aktif</p>'; return; }
            container.innerHTML = activeOrders.map(function(order) { return createOrderItem(order, false, true); }).join('');
        }

        function renderAdminDashboard() {
            document.getElementById('totalOrders').textContent = orders.length;
            document.getElementById('completedOrders').textContent = orders.filter(function(o) { return o.status === 'completed'; }).length;
            document.getElementById('pendingOrders').textContent = orders.filter(function(o) { return o.status === 'pending'; }).length;
            document.getElementById('cancelledOrders').textContent = orders.filter(function(o) { return o.status === 'cancelled'; }).length;
            const totalRevenue = orders.filter(function(o) { return o.status === 'completed' && o.orderCost; }).reduce(function(sum, o) { return sum + (o.orderCost || 0); }, 0);
            document.getElementById('totalRevenue').textContent = 'Rp ' + totalRevenue.toLocaleString('id-ID');
            const container = document.getElementById('adminOrderList');
            if (orders.length === 0) { container.innerHTML = '<p style="text-align: center; color: var(--gray-400); padding: 40px;">Belum ada order</p>'; return; }
            container.innerHTML = orders.map(function(order) { return createOrderItem(order, false, false, true); }).join('');
        }

        function getLocationLabel(locationKey) { return pickupLocations[locationKey] || locationKey; }
        function formatCurrency(amount) { if (amount === null || amount === undefined) return '<span class="cost-badge pending">Belum ditentukan</span>'; return 'Rp ' + (amount || 0).toLocaleString('id-ID'); }

        function createOrderItem(order, showActions, isDriver, isAdmin) {
            const statusClass = { 'pending': 'status-pending', 'processing': 'status-processing', 'onway': 'status-onway', 'completed': 'status-completed', 'cancelled': 'status-cancelled' }[order.status];
            const statusLabel = { 'pending': 'Pending', 'processing': 'Diproses', 'onway': 'Dalam Perjalanan', 'completed': 'Selesai', 'cancelled': 'Dibatalkan' }[order.status];
            const pickupLocationLabel = getLocationLabel(order.pickupLocation);
            let actions = '';
            if (showActions && currentRole === 'jaga') {
                if (order.status === 'pending') {
                    actions = '<div class="order-actions"><button class="btn btn-success" onclick="processOrder(\'' + order.id + '\')">âœ“ Terima</button><button class="btn btn-warning" onclick="openAssignModal(\'' + order.id + '\')">ğŸš— Assign</button><button class="btn btn-danger" onclick="openCancelModal(\'' + order.id + '\')">âŒ Batal</button><button class="btn btn-outline" onclick="viewOrderDetail(\'' + order.id + '\')">ğŸ“‹</button></div>';
                }
            } else if (isDriver && currentRole === 'driver') {
                if (order.status === 'onway' || order.status === 'processing') {
                    actions = '<div class="order-actions"><button class="btn btn-primary" onclick="startDelivery(\'' + order.id + '\')">ğŸš€ Mulai</button><button class="btn btn-outline" onclick="viewOrderDetail(\'' + order.id + '\')">ğŸ“‹</button></div>';
                }
            } else if (isAdmin) {
                if (order.status !== 'completed' && order.status !== 'cancelled') {
                    actions = '<div class="order-actions"><button class="btn btn-danger" onclick="openCancelModal(\'' + order.id + '\')">âŒ Batal</button><button class="btn btn-outline" onclick="viewOrderDetail(\'' + order.id + '\')">ğŸ“‹</button></div>';
                } else { actions = '<div class="order-actions"><button class="btn btn-outline" onclick="viewOrderDetail(\'' + order.id + '\')">ğŸ“‹ Detail</button></div>'; }
            } else {
                if (order.status === 'pending' && currentRole === 'perawatan') {
                    actions = '<div class="order-actions"><button class="btn btn-danger" onclick="openCancelModal(\'' + order.id + '\')">âŒ Batal</button><button class="btn btn-outline" onclick="viewOrderDetail(\'' + order.id + '\')">ğŸ“‹</button></div>';
                } else { actions = '<div class="order-actions"><button class="btn btn-outline" onclick="viewOrderDetail(\'' + order.id + '\')">ğŸ“‹ Detail</button></div>'; }
            }
            return '<div class="order-item"><div class="order-item-header"><span class="order-id">' + order.id + '</span><span class="status-badge ' + statusClass + '">' + statusLabel + '</span></div><div class="order-patient">ğŸ‘¤ ' + order.patientName + '</div><div class="order-details">ğŸ¥ RM: ' + order.medicalRecordNumber + '</div><div class="order-details">ğŸ“ <span class="location-icon">Dari: ' + pickupLocationLabel + '</span></div><div class="order-details">ğŸ¯ Ke: ' + order.destination + '</div><div class="order-details">ğŸ›ï¸ Ruang: ' + order.ward + '</div><div class="order-details">ğŸ• ' + formatDate(order.createdAt) + '</div>' + (order.assignedDriver ? '<div class="order-details">ğŸš— Driver: ' + order.assignedDriver.name + ' (' + order.assignedDriver.plate + ')</div>' : '') + '<div style="margin-top: 8px;">' + formatCurrency(order.orderCost) + '</div>' + actions + '</div>';
        }

        function processOrder(orderId) {
            const orderIndex = orders.findIndex(function(o) { return o.id === orderId; }); if (orderIndex === -1) return;
            orders[orderIndex].status = 'processing'; orders[orderIndex].processedAt = new Date().toISOString(); orders[orderIndex].processedBy = 'jaga';
            orders[orderIndex].timeline.push({ time: new Date().toISOString(), action: 'Order diterima oleh Petugas Jaga', status: 'completed' });
            saveOrders(); showNotification('success', 'Order Diterima', 'Order sedang diproses'); renderAllDashboards();
        }

        function openAssignModal(orderId) {
            orderToAssign = orders.find(function(o) { return o.id === orderId; }); if (!orderToAssign) return;
            const availableDrivers = drivers.filter(function(d) { return d.status === 'available'; });
            const driverSelect = document.getElementById('assignDriverSelect');
            driverSelect.innerHTML = '<option value="">Pilih driver tersedia</option>';
            availableDrivers.forEach(function(driver) { driverSelect.innerHTML += '<option value="' + driver.id + '">' + driver.name + ' - ' + driver.vehicle + ' (' + driver.plate + ')</option>'; });
            document.getElementById('assignOrderCost').value = ''; document.getElementById('assignModal').classList.add('show');
        }

        function closeAssignModal() { document.getElementById('assignModal').classList.remove('show'); document.getElementById('assignDriverSelect').value = ''; document.getElementById('assignOrderCost').value = ''; orderToAssign = null; }

        function confirmAssignDriver() {
            const driverId = document.getElementById('assignDriverSelect').value; const orderCost = document.getElementById('assignOrderCost').value;
            if (!driverId || !orderCost) { showNotification('error', 'Error', 'Pilih driver dan masukkan biaya order'); return; }
            const driver = drivers.find(function(d) { return d.id === parseInt(driverId); }); if (!driver) return;
            const orderIndex = orders.findIndex(function(o) { return o.id === orderToAssign.id; }); if (orderIndex === -1) return;
            orders[orderIndex].status = 'onway'; orders[orderIndex].assignedDriver = driver; orders[orderIndex].orderCost = parseInt(orderCost);
            orders[orderIndex].assignedAt = new Date().toISOString(); orders[orderIndex].assignedBy = 'jaga';
            orders[orderIndex].timeline.push({ time: new Date().toISOString(), action: 'Driver ' + driver.name + ' (' + driver.plate + ') ditugaskan - Biaya: Rp ' + parseInt(orderCost).toLocaleString('id-ID'), status: 'completed' });
            drivers.find(function(d) { return d.id === driver.id; }).status = 'busy'; saveDrivers(); saveOrders();
            showNotification('success', 'Driver Ditugaskan', driver.name + ' akan segera menjemput'); closeAssignModal(); renderAllDashboards();
        }

        function openCancelModal(orderId) { orderToCancel = orders.find(function(o) { return o.id === orderId; }); if (!orderToCancel) return; document.getElementById('cancelReason').value = ''; document.getElementById('cancelNotes').value = ''; document.getElementById('cancelModal').classList.add('show'); }
        function closeCancelModal() { document.getElementById('cancelModal').classList.remove('show'); document.getElementById('cancelReason').value = ''; document.getElementById('cancelNotes').value = ''; orderToCancel = null; }

        function confirmCancelOrder() {
            const cancelReason = document.getElementById('cancelReason').value; const cancelNotes = document.getElementById('cancelNotes').value.trim();
            if (!cancelReason) { showNotification('error', 'Error', 'Pilih alasan pembatalan'); return; }
            const orderIndex = orders.findIndex(function(o) { return o.id === orderToCancel.id; }); if (orderIndex === -1) return;
            if (orders[orderIndex].assignedDriver) {
                const driverIndex = drivers.findIndex(function(d) { return d.id === orders[orderIndex].assignedDriver.id; });
                if (driverIndex !== -1) { drivers[driverIndex].status = 'available'; saveDrivers(); }
            }
            orders[orderIndex].status = 'cancelled'; orders[orderIndex].cancelledAt = new Date().toISOString(); orders[orderIndex].cancelledBy = currentRole;
            orders[orderIndex].cancelReason = cancelReason; orders[orderIndex].cancelNotes = cancelNotes;
            orders[orderIndex].timeline.push({ time: new Date().toISOString(), action: 'Order dibatalkan oleh ' + roleNames[currentRole] + ' - Alasan: ' + cancelReasons[cancelReason], status: 'cancelled' });
            saveOrders(); showNotification('warning', 'Order Dibatalkan', 'Order telah dibatalkan'); closeCancelModal(); closeModal(); renderAllDashboards();
        }

        function addNewDriver() { document.getElementById('driverModal').classList.add('show'); }
        function closeDriverModal() { document.getElementById('driverModal').classList.remove('show'); document.getElementById('newDriverName').value = ''; document.getElementById('newDriverPhone').value = ''; document.getElementById('newDriverVehicle').value = ''; document.getElementById('newDriverPlate').value = ''; }
        function saveNewDriver() {
            const name = document.getElementById('newDriverName').value.trim(); const phone = document.getElementById('newDriverPhone').value.trim();
            const vehicle = document.getElementById('newDriverVehicle').value.trim(); const plate = document.getElementById('newDriverPlate').value.trim();
            if (!name || !phone || !vehicle || !plate) { showNotification('error', 'Error', 'Semua field harus diisi'); return; }
            const newDriver = { id: Date.now(), name: name, phone: phone, vehicle: vehicle, plate: plate, status: 'available' };
            drivers.push(newDriver); saveDrivers(); showNotification('success', 'Driver Ditambahkan', 'Driver ' + name + ' berhasil ditambahkan'); closeDriverModal(); renderAllDashboards();
        }

        function startDelivery(orderId) {
            selectedOrder = orders.find(function(o) { return o.id === orderId; }); if (!selectedOrder) return;
            if (selectedOrder.assignedDriver) { document.getElementById('driverNameAudit').value = selectedOrder.assignedDriver.name; document.getElementById('vehicleNumberAudit').value = selectedOrder.assignedDriver.plate; }
            document.getElementById('costAudit').value = selectedOrder.orderCost ? 'Rp ' + selectedOrder.orderCost.toLocaleString('id-ID') : 'Belum ditentukan';
            showNotification('success', 'Pengantaran Dimulai', 'Silakan dokumentasikan saat tiba'); renderAllDashboards();
        }

        function viewOrderDetail(orderId) {
            selectedOrder = orders.find(function(o) { return o.id === orderId; }); if (!selectedOrder) return;
            const modalBody = document.getElementById('modalBody'); const modalFooter = document.getElementById('modalFooter');
            const timeline = selectedOrder.timeline.map(function(t) { return '<div class="timeline-item ' + t.status + '"><div class="timeline-time">' + formatDate(t.time) + '</div><div class="timeline-content">' + t.action + '</div></div>'; }).join('');
            const beforePhotosHtml = selectedOrder.beforePhotos && selectedOrder.beforePhotos.length > 0 ? '<div class="photo-preview">' + selectedOrder.beforePhotos.map(function(p) { return '<div class="photo-item"><img src="' + p + '" alt="Foto"></div>'; }).join('') + '</div>' : '<p style="color: var(--gray-400);">Belum ada foto</p>';
            const arrivalPhotosHtml = selectedOrder.arrivalPhotos && selectedOrder.arrivalPhotos.length > 0 ? '<div class="photo-preview">' + selectedOrder.arrivalPhotos.map(function(p) { return '<div class="photo-item"><img src="' + p + '" alt="Foto"></div>'; }).join('') + '</div>' : '<p style="color: var(--gray-400);">Belum ada foto</p>';
            const pickupLocationLabel = getLocationLabel(selectedOrder.pickupLocation);
            let cancelInfo = '';
            if (selectedOrder.status === 'cancelled') {
                cancelInfo = '<div class="cancel-reason-section"><h4>âŒ Info Pembatalan</h4><div class="form-group" style="margin-bottom: 0;"><label>Alasan</label><input type="text" value="' + (cancelReasons[selectedOrder.cancelReason] || selectedOrder.cancelReason) + '" readonly style="background: var(--gray-100);"></div>' + (selectedOrder.cancelNotes ? '<div class="form-group" style="margin-bottom: 0; margin-top: 12px;"><label>Catatan</label><textarea readonly style="background: var(--gray-100);">' + selectedOrder.cancelNotes + '</textarea></div>' : '') + '<div class="form-group" style="margin-bottom: 0; margin-top: 12px;"><label>Dibatalkan Oleh</label><input type="text" value="' + roleNames[selectedOrder.cancelledBy] + ' pada ' + formatDate(selectedOrder.cancelledAt) + '" readonly style="background: var(--gray-100);"></div></div>';
            }
            let assignedDriverInfo = '';
            if (selectedOrder.assignedDriver) {
                assignedDriverInfo = '<div class="audit-section"><h4>ğŸš— Info Driver & Kendaraan</h4><div class="form-row"><div class="form-group" style="margin-bottom: 0;"><label>Nama Driver</label><input type="text" value="' + selectedOrder.assignedDriver.name + '" readonly style="background: var(--gray-100);"></div><div class="form-group" style="margin-bottom: 0;"><label>Nomor Kendaraan</label><input type="text" value="' + selectedOrder.assignedDriver.plate + '" readonly style="background: var(--gray-100);"></div></div><div class="form-group" style="margin-bottom: 0; margin-top: 12px;"><label>Kendaraan</label><input type="text" value="' + selectedOrder.assignedDriver.vehicle + '" readonly style="background: var(--gray-100);"></div><div class="form-group" style="margin-bottom: 0; margin-top: 12px;"><label>Ditugaskan Oleh</label><input type="text" value="' + (selectedOrder.assignedBy ? 'Petugas Jaga' : '-') + ' pada ' + (selectedOrder.assignedAt ? formatDate(selectedOrder.assignedAt) : '-') + '" readonly style="background: var(--gray-100);"></div></div>';
            }
            
            // Print Button Logic
            const printBtn = `<button class="btn btn-outline" onclick="window.print()" style="width:auto; margin-right: 10px;">ğŸ–¨ï¸ Cetak Detail</button>`;

            modalBody.innerHTML = '<div class="form-group"><label>ID Order</label><input type="text" value="' + selectedOrder.id + '" readonly style="background: var(--gray-100);"></div>' +
                '<div class="form-row"><div class="form-group"><label>Nomor Rekam Medik</label><input type="text" value="' + selectedOrder.medicalRecordNumber + '" readonly style="background: var(--gray-100);"></div><div class="form-group"><label>Nama Pasien</label><input type="text" value="' + selectedOrder.patientName + '" readonly style="background: var(--gray-100);"></div></div>' +
                '<div class="form-row"><div class="form-group"><label>Tempat, Tanggal Lahir</label><input type="text" value="' + selectedOrder.birthPlace + ', ' + formatDateOnly(selectedOrder.birthDate) + '" readonly style="background: var(--gray-100);"></div><div class="form-group"><label>Umur / Gender</label><input type="text" value="' + selectedOrder.patientAge + ' / ' + (selectedOrder.patientGender === 'L' ? 'Laki-laki' : 'Perempuan') + '" readonly style="background: var(--gray-100);"></div></div>' +
                '<div class="form-group"><label>Kontak</label><input type="text" value="' + selectedOrder.patientPhone + '" readonly style="background: var(--gray-100);"></div>' +
                '<div class="form-row"><div class="form-group"><label>Kondisi</label><input type="text" value="' + selectedOrder.patientCondition + '" readonly style="background: var(--gray-100);"></div><div class="form-group"><label>Ruang/Bangsal</label><input type="text" value="' + selectedOrder.ward + '" readonly style="background: var(--gray-100);"></div></div>' +
                '<div class="form-group"><label>Lokasi Penjemputan</label><input type="text" value="' + pickupLocationLabel + '" readonly style="background: var(--gray-100);"></div>' +
                '<div class="form-group"><label>Tujuan</label><input type="text" value="' + selectedOrder.destination + '" readonly style="background: var(--gray-100);"></div>' +
                '<div class="form-row"><div class="form-group"><label>Biaya Order</label><input type="text" value="' + (selectedOrder.orderCost ? 'Rp ' + selectedOrder.orderCost.toLocaleString('id-ID') : 'Belum ditentukan') + '" readonly style="background: var(--gray-100); font-weight: 700;"></div><div class="form-group"><label>Status</label><input type="text" value="' + selectedOrder.status.toUpperCase() + '" readonly style="background: var(--gray-100);"></div></div>' +
                (selectedOrder.notes ? '<div class="form-group"><label>Catatan</label><textarea readonly style="background: var(--gray-100);">' + selectedOrder.notes + '</textarea></div>' : '') +
                assignedDriverInfo + cancelInfo +
                '<div class="documentation-section"><h4>ğŸ“¸ Dokumentasi Sebelum Berangkat</h4>' + beforePhotosHtml + '</div>' +
                (selectedOrder.arrivalPhotos ? '<div class="documentation-section"><h4>ğŸ“ Dokumentasi Saat Tiba</h4>' + arrivalPhotosHtml + '</div>' : '') +
                (selectedOrder.deliveryNotes ? '<div class="form-group"><label>Catatan Pengantaran</label><textarea readonly style="background: var(--gray-100);">' + selectedOrder.deliveryNotes + '</textarea></div>' : '') +
                '<div class="documentation-section"><h4>ğŸ“… Timeline (Audit Trail)</h4><div class="timeline">' + timeline + '</div></div>';

            let footerButtons = printBtn + '<button class="btn btn-outline" onclick="closeModal()">Tutup</button>';
            if (selectedOrder.status !== 'cancelled' && selectedOrder.status !== 'completed') {
                if (currentRole === 'admin' || currentRole === 'jaga' || (currentRole === 'perawatan' && selectedOrder.status === 'pending')) {
                    footerButtons = printBtn + '<button class="btn btn-outline" onclick="closeModal()">Kembali</button><button class="btn btn-danger" onclick="openCancelModal(\'' + selectedOrder.id + '\')">âŒ Batal Order</button>';
                }
            }
            modalFooter.innerHTML = footerButtons;
            document.getElementById('orderModal').classList.add('show');
        }

        function formatDateOnly(dateString) { if (!dateString) return '-'; const date = new Date(dateString); return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }); }
        function closeModal() { document.getElementById('orderModal').classList.remove('show'); selectedOrder = null; }
        function showNotification(type, title, message) {
            const notification = document.getElementById('notification');
            notification.className = 'notification ' + type + ' show';
            notification.querySelector('.notification-title').textContent = title;
            notification.querySelector('.notification-message').textContent = message;
            notification.querySelector('.notification-icon').textContent = type === 'success' ? 'âœ“' : (type === 'error' ? 'âœ•' : '!');
            setTimeout(function() { notification.classList.remove('show'); }, 4000);
        }
        function formatDate(dateString) { const date = new Date(dateString); return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }); }

        // Report Generation
        function generateReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            if (!startDate || !endDate) { showNotification('error', 'Error', 'Pilih tanggal laporan'); return; }

            const filteredOrders = orders.filter(function(o) {
                const orderDate = o.createdAt.split('T')[0];
                return orderDate >= startDate && orderDate <= endDate;
            });

            let totalCost = 0;
            let completedCount = 0;
            let tableRows = '';

            filteredOrders.forEach(function(o) {
                if (o.orderCost) totalCost += o.orderCost;
                if (o.status === 'completed') completedCount++;
                tableRows += '<tr style="border-bottom: 1px solid #eee;">' +
                    '<td style="padding: 8px;">' + formatDate(o.createdAt) + '</td>' +
                    '<td style="padding: 8px;">' + o.id + '</td>' +
                    '<td style="padding: 8px;">' + o.patientName + '</td>' +
                    '<td style="padding: 8px;">' + o.pickupLocation + ' â†’ ' + o.destination + '</td>' +
                    '<td style="padding: 8px;"><span class="status-badge status-' + o.status + '">' + o.status + '</span></td>' +
                    '<td style="padding: 8px; text-align: right;">' + (o.orderCost ? 'Rp ' + o.orderCost.toLocaleString('id-ID') : '-') + '</td>' +
                    '</tr>';
            });

            const reportHtml = '<div style="text-align: center; margin-bottom: 20px;"><h3>Laporan Operasional MediTransport</h3><p>Periode: ' + formatDateOnly(startDate) + ' s/d ' + formatDateOnly(endDate) + '</p></div>' +
                '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;"><thead><tr style="background: #f3f4f6; text-align: left;"><th style="padding: 10px;">Tanggal</th><th style="padding: 10px;">ID Order</th><th style="padding: 10px;">Pasien</th><th style="padding: 10px;">Rute</th><th style="padding: 10px;">Status</th><th style="padding: 10px; text-align: right;">Biaya</th></tr></thead><tbody>' + tableRows + '</tbody></table>' +
                '<div style="display: flex; justify-content: space-between; margin-top: 20px; padding-top: 20px; border-top: 2px solid #333;"><div><strong>Total Order:</strong> ' + filteredOrders.length + '<br><strong>Selesai:</strong> ' + completedCount + '</div><div style="text-align: right;"><strong>Total Pendapatan:</strong><br><span style="font-size: 24px; color: var(--primary);">Rp ' + totalCost.toLocaleString('id-ID') + '</span></div></div>' +
                '<div style="margin-top: 40px; text-align: center; font-size: 12px; color: #666;">Dicetak oleh: ' + roleNames[currentRole] + ' pada ' + new Date().toLocaleString('id-ID') + '</div>';

            document.getElementById('reportPreview').innerHTML = reportHtml;
            showNotification('success', 'Laporan Dibuat', 'Laporan periode terpilih telah ditampilkan');
        }

        // Close modals on outside click
        document.getElementById('orderModal').addEventListener('click', function(e) { if (e.target === this) closeModal(); });
        document.getElementById('driverModal').addEventListener('click', function(e) { if (e.target === this) closeDriverModal(); });
        document.getElementById('assignModal').addEventListener('click', function(e) { if (e.target === this) closeAssignModal(); });
        document.getElementById('cancelModal').addEventListener('click', function(e) { if (e.target === this) closeCancelModal(); });
    </script>
</body>
</html>

